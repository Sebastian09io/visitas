 {% extends "administracion/base_admin.html" %}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

{% block content %}
<style>
    .form_group_v input,select{
        max-width:290px;
        min-width:270px;
    }
</style>

<div class="contenedor_visita">
    <h1 class="titulo_visita">Registro de visita</h1>

    {% if messages %}
    <div class="container mt-3" id="messages-container">
        {% for message in messages %}
            <div class="alert {{ message.tags }}">
                {{ message }}
            </div>
        {% endfor %}
    </div>
    {% endif %}

    <form class="formulario_visita" method="post" enctype="multipart/form-data" id="mainForm">
        {% csrf_token %}
        <div class="row">
            <div class="col-md-6 espacio_v2">
                <div class="form-row">
                    <div class="form-group form_group_v col-md-6">
                        <label for="nombres">Nombres</label>
                        <input type="text" class="form-control" value="{{ user.nombres }}" readonly>
                    </div>
                    <div class="form-group form_group_v col-md-6">
                        <label for="apellidos">Apellidos</label>
                        <input type="text" class="form-control" value="{{ user.apellidos }}" readonly>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group form_group_v col-md-6">
                        <label for="correo">Correo</label>
                        <input type="text" class="form-control" value="{{ user.correo }}" readonly>
                    </div>
                    <div class="form-group form_group_v col-md-6">
                        <label>Autoriza grabación:</label>
                        <div class="d-flex align-items-center">
                            <img id="grabacion-on" class="btn-estado_v mr-2" src="/static/bootstrap/img/on.png" style="display: {% if user.id_visita.grabacion %} block {% else %} none {% endif %};">
                            <img id="grabacion-off" class="btn-estado_v" src="/static/bootstrap/img/off.png" style="display: {% if user.id_visita.grabacion %} none {% else %} block {% endif %};">
                            <input type="hidden" name="grabacion" id="grabacion-input" value="{{ user.id_visita.grabacion }}">
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group form_group_v col-md-6">
                        <label for="id_tipo_documento">Tipo Documento</label>
                        <input type="text" class="form-control" value="{{ user.id_tipo_documento }}" readonly>
                    </div>
                    <div class="form-group form_group_v col-md-6">
                        <label for="identificacion">Identificación</label>
                        <input type="text" class="form-control" value="{{ user.identificacion }}" readonly>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group form_group_v col-md-6">
                        <label for="telefono">Teléfono</label>
                        <input type="text" class="form-control" value="{{ user.telefono }}" readonly>
                    </div>
                    <div class="form-group  form_group_v col-md-6">
                        <label for="{{ form.id_genero.id_for_label }}">Género</label>
                        {{ form.id_genero }}
                    </div>
                </div>
            </div>


            <div class="col-md-6 espacio_v">
                <div class="form-row">
                    <div class="form-group form_group_v col-md-6">
                        <label for="{{ form.procedencia.id_for_label }}">Procedencia</label>
                        {{ form.procedencia }}
                    </div>
                    <div class="form-group form_group_v col-md-6">
                        <label for="{{ form.discapacidad.id_for_label }}">Discapacidad</label>
                        {{ form.discapacidad }}
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group form_group_v col-md-6">
                        <label for="{{ form.id_area.id_for_label }}">Estrategia</label>
                        {{ form.id_area }}
                    </div>
                    <div class="form-group form_group_v col-md-6" id="linea-field" style="display: none;">
                        <label for="{{ form.id_linea.id_for_label }}">Línea</label>
                        {{ form.id_linea }}
                    </div>
                    <div class="form-group form_group_v col-md-6" id="ambiente-field" style="display: none;">
                        <label for="{{ form.id_ambiente.id_for_label }}">Ambiente</label>
                        {{ form.id_ambiente }}
                    </div>
                    <div class="form-group form_group_v col-md-6" id="espacio-field" >
                        <label>Espacio</label>
                        <input type="text" value="Seleccione primero la estrategia" class="form-control" readonly>
                    </div>
                    <div class="form-group form_group_v col-md-6" id="no-permitido-field" style="display: none;">
                        <label>Espacio</label>
                        <input type="text" value="No aplica" class="form-control" readonly>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group form_group_v col-md-6">
                        <label for="fecha_inicio">Fecha de inicio</label>
                        {{ form.fecha_inicio }}
                    </div>
                    <div class="form-group form_group_v col-md-6">
                        <label for="fecha_finalizacion">Fecha de finalización</label>
                        {{ form.fecha_finalizacion }}
                    </div>
                </div>




            </div>
        </div>
        

    </form>

    <div class="vertical-line_v"></div>
    <div class="horizontal_line_"></div>


<!-- registro asistentes -->
<div class="contenedor_visita2">
    <h1 class="titulo_visita">Registro de asistentes</h1>
    <form class="formulario_visita2" id="asistentesForm">
        {% csrf_token %}
        <div class="row">
            <!-- Campos del asistente -->
            <div class="col-md-6 espacio_v2">
                <div class="form-row">
                    <div class="form-group form_group_v col-md-6">
                        <label for="nombres_asistente">Nombres</label>
                        {{form.nombre_asistente}}
                    </div>
                    <div class="form-group form_group_v col-md-6">
                        <label for="apellidos_asistente">Apellidos</label>
                        {{form.apellidos_asistente}}
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group form_group_v col-md-6">
                        <label for="correo_asistente">Correo</label>
                        {{form.correo_asistente}}
                    </div>
                    <div class="form-group form_group_v col-md-6">
                        <label for="telefono_asistente">Teléfono</label>
                        {{form.telefono_asistente}}
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group form_group_v col-md-6">
                        <label for="id_tipo_documento_asistente">Tipo Documento</label>
                        {{form.id_tipo_documento_asistente }}
                    </div>
                    <div class="form-group form_group_v col-md-6">
                        <label for="identificacion_asistente">Identificación</label>
                        {{form.identificacion_asistente}}
                    </div>
                </div>
            </div>

            <div class="col-md-6 espacio_v3">
                <div class="form-row">
                    <div class="form-group form_group_v2 col-md-6">
                        <label class="letrat">c</label>
                        <button type="button" class="btn btnt2 btn-primary" id="agregarAsistente">Agregar</button>
                    </div>

                </div>

            </div>

        </div>

    </form>

    <div class="vertical-line_v2"></div>
</div>

<!-- listado asistentes -->
<div class="contenedor_visita3">
    <h1 class="titulo_visita">Listado de asistentes</h1>

    <div class="mt-4">
        <div class="row">
            <div class="col-md-12">
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="funcionarios-table" class="table table-striped table-bordered">
                            <thead class="table-dark">
                                <tr>
                                    <th scope="col">#</th>
                                    <th scope="col">Nombres</th>
                                    <th scope="col">Apellidos</th>
                                    <th scope="col">Teléfono</th>
                                    <th scope="col">Tipo Identificación</th>
                                    <th scope="col">Identificación</th>
                                    <th scope="col">Correo</th>

                                </tr>
                            </thead>
                            <tbody id="asistentesTableBody">
                                <!-- Aquí se agregarán las filas con JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

<!-- Botón para guardar la visita -->
<button type="submit" form="mainForm" class="btn btn-primary">Guardar visita</button>

</div>
</div>




<script>
    // Script para manejar la grabación
    document.getElementById('grabacion-on').onclick = function() {
        this.style.display = 'none';
        document.getElementById('grabacion-off').style.display = 'block';
        document.getElementById('grabacion-input').value = 'False';
    };

    document.getElementById('grabacion-off').onclick = function() {
        this.style.display = 'none';
        document.getElementById('grabacion-on').style.display = 'block';
        document.getElementById('grabacion-input').value = 'True';
    };

    document.addEventListener("DOMContentLoaded", function() {
        var areaField = document.getElementById('id_id_area'); // Asegúrate de que este id coincida
        var lineaField = document.getElementById('linea-field');
        var ambienteField = document.getElementById('ambiente-field');
        var espacioField = document.getElementById('espacio-field');
        var nopermiteField = document.getElementById('no-permitido-field');
    
        function updateFields() {
            var selectedValue = areaField.options[areaField.selectedIndex].text; // Obtener el texto del valor seleccionado
    
            // Ocultar todos los campos y eliminar el atributo required
            lineaField.style.display = "none";
            ambienteField.style.display = "none";
            espacioField.style.display = "none";
            nopermiteField.style.display = "none";
    
            lineaField.querySelector('select').removeAttribute('required');
            ambienteField.querySelector('select').removeAttribute('required');
            espacioField.querySelector('input').removeAttribute('required');
            nopermiteField.querySelector('input').removeAttribute('required');
    
            if (selectedValue === "Tecnoparque") {
                lineaField.style.display = "block";
                lineaField.querySelector('select').setAttribute('required', 'required');
            } else if (selectedValue === "Tecnoacademia") {
                ambienteField.style.display = "block";
                ambienteField.querySelector('select').setAttribute('required', 'required');
            } else if (selectedValue === "Sennova") {
                nopermiteField.style.display = "block";
                nopermiteField.querySelector('input').setAttribute('required', 'required');
            } else {
                espacioField.style.display = "block";
                espacioField.querySelector('input').setAttribute('required', 'required');
            }
        }
    
        // Inicializar campos al cargar la página
        updateFields();
    
        // Actualizar campos cuando cambie el área
        areaField.addEventListener("change", updateFields);
    });
    
    
    ///asistentes
    document.addEventListener("DOMContentLoaded", function() {
        let asistentes = [];
    
        document.getElementById('agregarAsistente').addEventListener('click', function() {
            // Obtener valores del formulario de asistente
            const nombres = document.querySelector('input[name="nombre_asistente"]').value;
            const apellidos = document.querySelector('input[name="apellidos_asistente"]').value;
            const correo = document.querySelector('input[name="correo_asistente"]').value;
            const telefono = document.querySelector('input[name="telefono_asistente"]').value;
            const idTipoDocumento = document.querySelector('select[name="id_tipo_documento_asistente"]').value;
            const identificacion = document.querySelector('input[name="identificacion_asistente"]').value;
    
            // Validar los campos
            if (!nombres || !apellidos || !correo || !telefono || !idTipoDocumento || !identificacion) {
                alert('Por favor complete todos los campos');
                return;
            }
    
            // Crear una nueva fila en la tabla
            const tableBody = document.getElementById('asistentesTableBody');
            const rowCount = tableBody.rows.length + 1;
            const row = tableBody.insertRow();
            row.innerHTML = `
                <th scope="row">${rowCount}</th>
                <td>${nombres}</td>
                <td>${apellidos}</td>
                <td>${telefono}</td>
                <td>${idTipoDocumento}</td>
                <td>${identificacion}</td>
                <td>${correo}</td>

            `;
    
            // Agregar el asistente al array
            asistentes.push({
                nombres, apellidos, correo, telefono, idTipoDocumento, identificacion
            });
            // Limpiar campos
            document.querySelector('input[name="nombre_asistente"]').value = '';
            document.querySelector('input[name="apellidos_asistente"]').value = '';
            document.querySelector('input[name="correo_asistente"]').value = '';
            document.querySelector('input[name="telefono_asistente"]').value = '';
            document.querySelector('select[name="id_tipo_documento_asistente"]').value = '';
            document.querySelector('input[name="identificacion_asistente"]').value = '';
        });
    
        // Enviar el formulario con los datos de los asistentes
        document.getElementById('mainForm').addEventListener('submit', function(e) {
            // Añadir los asistentes como un campo oculto en el formulario
            const asistentesInput = document.createElement('input');
            asistentesInput.type = 'hidden';
            asistentesInput.name = 'asistentes';
            asistentesInput.value = JSON.stringify(asistentes);
            this.appendChild(asistentesInput);
        });
    });
    
</script>

{% endblock %}
